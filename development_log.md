# 开发日志

## 项目名称：全人类蛋白质组药物重定位项目

### 项目目标更新（2024-04-19）

#### 核心目标
- 发现已知药物的新靶点和新用途
- 通过对比已知结合数据建立评分基线
- 基于相对评分预测新的药物-蛋白质相互作用

#### 关键策略
1. Baseline建立
   - 收集已知药物-蛋白质结合数据
   - 对已知结合对进行分子对接
   - 建立对接得分与实验数据的对应关系
   - 计算相对评分标准

2. 新用途预测
   - 对目标蛋白质进行分子对接
   - 计算相对于baseline的得分
   - 评估潜在结合可能性
   - 提供可信度评估

#### 数据分层策略（修订版）

1. 第一层（Baseline数据）
   - 有实验结合数据（Kd/Ki/IC50）
   - 有高质量实验结构（分辨率<2.5Å）
   - 可用于建立评分基准
   - 来源：PDBbind、BindingDB精选集

2. 第二层（次优数据）
   - 有实验结合数据
   - 使用预测结构（AlphaFold）
   - 可用于扩展评分基准
   - 来源：BindingDB、ChEMBL

3. 第三层（结构导向）
   - 有高质量实验结构
   - 无结合数据
   - 适合结构导向筛选
   - 来源：PDB精选结构

4. 第四层（预测导向）
   - 仅有预测结构
   - 无结合数据
   - 用于广谱筛选
   - 来源：AlphaFold数据库

#### 实施重点

1. 数据获取与预处理
   - 结合数据
     * PDBbind核心集（高质量）
     * BindingDB实验数据
     * ChEMBL活性数据
   - 结构数据
     * PDB实验结构
     * AlphaFold预测结构
   - 药物数据
     * DrugBank已批准药物
     * ZINC药物库

2. Baseline系统
   - 数据选择
     * 筛选高质量结合数据
     * 确保结构完整性
     * 验证实验条件
   - 对接准备
     * 结构预处理
     * 配体准备
     * 口袋定义
   - 评分建立
     * 对接计算
     * 得分标准化
     * 相关性分析
     * 阈值确定

3. 预测系统
   - 目标选择
     * 按分层策略筛选
     * 评估结构质量
     * 确定优先级
   - 对接实施
     * 批量对接
     * 结果分析
     * 质量控制
   - 结果评估
     * 相对得分计算
     * 可信度评估
     * 结果排序
     * 建议生成

#### 优先任务

1. 第一阶段（1-2周）
   - 建立Baseline数据集
   - 实现基本对接流程
   - 开发评分系统

2. 第二阶段（2-3周）
   - 扩展到其他层级
   - 完善预测系统
   - 建立质量控制

3. 第三阶段（1-2周）
   - 系统整合
   - 结果验证
   - 文档完善

### 开发计划（2024-04-19）

#### 第一阶段：基础设施建设（预计 1-2 周）

1. 测试框架搭建
   - 创建单元测试框架（使用 pytest）
   - 为每个模块创建测试文件
   - 实现基本的测试用例
   - 设置测试覆盖率检查（使用 coverage.py）
   - 配置持续集成（GitHub Actions）

2. 日志系统实现
   - 创建统一的日志配置
   - 实现不同级别的日志记录
   - 添加日志轮转机制
   - 为关键操作添加日志记录
   - 实现日志分析工具

3. 错误处理完善
   - 定义自定义异常类
   - 实现全局异常处理器
   - 添加错误恢复机制
   - 完善错误提示信息
   - 实现错误报告系统

#### 第二阶段：功能完善与验证（预计 2-3 周）

1. 数据处理模块
   - 完善数据获取功能
   - 优化数据清洗流程
   - 增强数据验证机制
   - 添加数据缓存机制
   - 实现数据版本控制

2. 分子对接模块
   - 完善对接算法
   - 优化参数配置
   - 添加结果验证
   - 实现并行计算
   - 优化内存使用

3. 评分系统
   - 完善评分算法
   - 添加新的评分指标
   - 实现评分标准化
   - 添加评分验证
   - 优化评分性能

#### 第三阶段：文档与优化（预计 1-2 周）

1. 文档完善
   - 编写详细的 API 文档
   - 创建用户使用指南
   - 添加代码示例
   - 编写部署文档
   - 创建故障排除指南

2. 性能优化
   - 进行性能分析
   - 优化关键算法
   - 改进数据结构
   - 添加缓存机制
   - 优化内存使用

3. 可视化与报告
   - 实现结果可视化
   - 创建分析报告模板
   - 添加导出功能
   - 优化展示效果
   - 实现交互式分析

#### 第四阶段：测试与发布（预计 1 周）

1. 系统测试
   - 进行集成测试
   - 执行性能测试
   - 进行压力测试
   - 验证错误处理
   - 检查日志系统

2. 部署准备
   - 准备发布文档
   - 创建安装脚本
   - 配置部署环境
   - 准备示例数据
   - 编写部署指南

3. 发布与维护
   - 版本发布
   - 更新文档
   - 收集反馈
   - 修复问题
   - 规划后续更新

### 2024-04-19

#### 修改内容
- 重构项目目录结构，将代码按功能模块分类
- 更新了所有模块的导入语句和路径设置
- 创建了统一的数据目录结构
- 清理了临时目录中的文件

#### 文件变更
1. `src/data/adapters/data_adapters.py`
   - 更新了导入语句
   - 使用 Path 对象进行路径管理
   - 统一了数据目录结构

2. `src/data/crawlers/data_crawler.py`
   - 更新了导入语句
   - 使用 Path 对象进行路径管理
   - 统一了数据目录结构

3. `src/data/manager/unified_data_manager.py`
   - 更新了导入语句
   - 修正了适配器导入路径
   - 统一了数据目录结构

4. `src/docking/core/docking_module.py`
   - 添加了结果目录管理
   - 使用 Path 对象进行路径管理
   - 自动创建必要的目录结构

5. 清理工作
   - 删除了 temp_dir 中的临时文件
   - 确认所有文件都已正确移动到目标位置

#### 测试结果
- 待进行

#### 遇到的问题
- 需要确保所有模块的依赖关系正确
- 需要验证路径管理在不同操作系统下的兼容性

#### 解决方案
- 使用 pathlib.Path 进行跨平台路径管理
- 统一使用相对导入

#### 后续计划
1. 编写单元测试
2. 验证各模块功能
3. 添加日志记录
4. 完善错误处理
5. 编写使用文档

### 数据处理模块工作计划（2024-04-19更新）

#### 一、数据来源扩展

1. 蛋白质基础数据
   - UniProt（序列和功能注释）
   - PDB（实验结构）
   - AlphaFold（预测结构）
   - STRING（蛋白质相互作用网络）
   - Reactome（生物学通路）

2. 药物相关数据
   - DrugBank（药物信息）
   - ChEMBL（生物活性数据）
   - ZINC（化合物库）
   - PharmGKB（药物基因组学）
   - TTD（治疗靶点数据库）

3. 疾病关联数据
   - DisGeNET（疾病-基因关联）
   - OpenTargets（靶点-疾病关联）
   - KEGG（代谢通路）
   - OMIM（遗传病数据）
   - GWASCatalog（基因组关联研究）

4. 结合数据
   - PDBbind（实验结构复合物）
   - BindingDB（结合亲和力数据）
   - ChEMBL（结合数据）
   - DrugBank（已知结合数据）
   - DGIdb（药物-基因相互作用）

#### 二、数据质量分层

1. 蛋白质结构分层
   - 第一层：高分辨率晶体结构（<2.0Å）
   - 第二层：中等分辨率结构（2.0-3.0Å）
   - 第三层：低分辨率结构（>3.0Å）
   - 第四层：AlphaFold高置信度预测
   - 第五层：其他预测结构

2. 结合数据分层
   - 第一层：有晶体结构的实验Kd/Ki数据
   - 第二层：无结构的实验Kd/Ki数据
   - 第三层：IC50数据
   - 第四层：活性定性数据
   - 第五层：预测数据

3. 疾病关联分层
   - 第一层：临床验证的关联
   - 第二层：实验验证的关联
   - 第三层：文献支持的关联
   - 第四层：计算预测的关联
   - 第五层：推测的关联

#### 三、数据整合策略

1. 数据标准化
   - 统一蛋白质标识符（UniProt ID）
   - 统一化合物标识符（InChI/SMILES）
   - 统一疾病分类（DO/ICD）
   - 统一基因命名（HGNC）
   - 建立交叉引用映射

2. 质量控制
   - 实验方法评估
   - 数据一致性检查
   - 来源可靠性评估
   - 时间戳验证
   - 版本控制

3. 更新机制
   - 增量更新策略
   - 数据版本管理
   - 变更追踪
   - 历史记录保存
   - 回滚机制

#### 四、数据处理流程

1. 数据获取
   - API接入实现
   - 自动化下载
   - 格式解析
   - 错误处理
   - 进度监控

2. 数据清洗
   - 结构数据清洗
   - 序列比对验证
   - 异常值检测
   - 重复数据处理
   - 缺失值处理

3. 数据集成
   - 关系建立
   - 数据合并
   - 冲突解决
   - 质量评估
   - 结果验证

#### 五、存储与检索

1. 数据组织
   - 分层存储结构
   - 索引建立
   - 压缩策略
   - 备份机制
   - 访问控制

2. 查询优化
   - 多维索引
   - 缓存机制
   - 并行处理
   - 预加载策略
   - 查询优化

#### 优先实施任务

1. 完整数据源接入
   - 实现所有数据源的基本获取
   - 建立数据更新机制
   - 实现错误处理和重试
   - 添加数据验证
   - 建立监控系统

2. 数据质量评估体系
   - 实现分层标准
   - 建立评估指标
   - 开发质量检测工具
   - 实现自动分类
   - 生成质量报告

#### 优先任务（本周）

1. 数据获取可靠性
   - 实现重试机制
   - 添加错误处理
   - 实现数据验证
   - 建立监控机制
   - 完善日志记录

2. 数据标准化
   - 定义标准格式
   - 实现转换工具
   - 添加验证机制
   - 建立测试用例
   - 编写文档说明

### 数据系统实施计划（2024-04-19）

#### 一、数据适配器系统扩展

1. 基础设施
   - 创建适配器基类增强版
   - 实现通用重试装饰器
   - 添加数据缓存机制
   - 实现请求限速控制
   - 添加详细日志记录

2. 蛋白质数据适配器
   - UniProtAdapter
     * 序列数据获取
     * 功能注释解析
     * GO术语映射
     * 蛋白质家族分类
   - PDBAdapter（增强）
     * 结构文件处理
     * 质量评估
     * 链信息提取
     * 配体识别
   - AlphaFoldAdapter
     * 预测结构获取
     * 置信度评估
     * 结构比对
   - STRINGAdapter
     * 相互作用网络
     * 置信度评分
     * 实验证据分类
   - ReactomeAdapter
     * 通路数据
     * 反应网络
     * 调控关系

3. 药物数据适配器
   - DrugBankAdapter（增强）
     * 药物信息获取
     * 结构数据处理
     * 靶点关联
     * 适应症映射
   - ChEMBLAdapter
     * 活性数据
     * 实验数据
     * 文献引用
   - ZINCAdapter
     * 化合物库
     * 性质计算
     * 相似性搜索
   - PharmGKBAdapter
     * 基因组关联
     * 变异信息
     * 临床注释
   - TTDAdapter
     * 靶点信息
     * 药物关联
     * 疾病映射

4. 疾病数据适配器
   - DisGeNETAdapter
     * 疾病-基因关联
     * 证据评分
     * 文献支持
   - OpenTargetsAdapter
     * 靶点-疾病关联
     * 证据类型
     * 置信度评分
   - KEGGAdapter
     * 通路数据
     * 代谢网络
     * 疾病关联
   - OMIMAdapter
     * 遗传病数据
     * 基因型-表型
     * 临床特征
   - GWASAdapter
     * 关联研究
     * 统计显著性
     * 人群信息

#### 二、数据分层评估系统

1. 评估标准定义
   - 结构数据评估
     * 分辨率评分
     * 结构完整性
     * R因子评估
     * 实验方法权重
     * 时间因素
   - 结合数据评估
     * 实验类型权重
     * 数据可靠性
     * 重复实验数
     * 条件一致性
     * 方法学评分
   - 疾病关联评估
     * 证据类型分级
     * 实验支持度
     * 临床相关性
     * 文献支持度
     * 时效性评分

2. 自动分类系统
   - 评分计算模块
     * 多维度评分
     * 权重系统
     * 阈值定义
     * 综合评价
   - 分类规则引擎
     * 规则定义
     * 规则应用
     * 结果验证
     * 异常处理
   - 质量报告生成
     * 评分详情
     * 分类依据
     * 建议措施
     * 改进方向

#### 三、数据标准化框架

1. 标识符系统
   - 蛋白质标识符
     * UniProt AC主键
     * ID映射表
     * 版本控制
     * 历史追踪
   - 化合物标识符
     * InChI主键
     * SMILES表示
     * CAS号映射
     * 异构体处理
   - 疾病标识符
     * DO本体
     * ICD映射
     * UMLS集成
     * 症状关联

2. 数据转换系统
   - 格式转换器
     * 序列格式
     * 结构格式
     * 化学格式
     * 关系数据
   - 单位转换
     * 浓度单位
     * 能量单位
     * 结构单位
     * 时间单位
   - 命名转换
     * 基因名称
     * 蛋白质名称
     * 化合物名称
     * 疾病名称

3. 验证系统
   - 数据完整性
     * 必填字段
     * 格式规范
     * 值域范围
     * 关系完整
   - 一致性检查
     * 跨源一致
     * 时间一致
     * 关系一致
     * 逻辑一致
   - 质量控制
     * 异常检测
     * 重复处理
     * 冲突解决
     * 版本控制

#### 实施优先级

1. 第一阶段（1-2周）
   - 完善基础适配器
   - 实现核心数据源适配
   - 建立基本评估标准
   - 实现标识符统一

2. 第二阶段（2-3周）
   - 扩展其他数据源
   - 实现自动分类
   - 完善转换系统
   - 添加验证机制

3. 第三阶段（1-2周）
   - 系统整合测试
   - 性能优化
   - 文档完善
   - 部署准备

### 2024-04-19 更新（下午）

#### 重要更新：添加Google Drive存储支持

1. 核心改进
   - 实现了Google Drive数据管理器
   - 添加了本地缓存机制
   - 支持文件夹层级管理
   - 实现了文件上传、下载、删除功能

2. 新增功能
   - Google Drive认证和授权
   - 文件夹自动创建和管理
   - 本地缓存管理
   - 文件同步机制

3. 代码变更
   - 新增 `src/data/storage/google_drive_manager.py`
     * 实现了GoogleDriveManager类
     * 添加了文件操作方法
     * 实现了缓存管理
   - 新增 `tests/unit/test_google_drive_manager.py`
     * 添加了完整的单元测试
     * 实现了Mock测试
     * 覆盖了所有核心功能

4. 依赖更新
   - 添加了Google Drive API相关依赖
     * google-api-python-client
     * google-auth-httplib2
     * google-auth-oauthlib
     * pydrive2

5. 后续计划
   - 实现数据同步策略
   - 添加并发上传支持
   - 优化缓存机制
   - 添加进度监控
   - 实现断点续传

### 2024-04-19 更新（晚间）

#### 重要更新：添加Colab运行支持

1. 核心改进
   - 创建了Colab运行环境
   - 实现了Google Drive集成
   - 优化了数据缓存策略
   - 添加了GPU支持

2. 新增功能
   - Colab notebook (`notebooks/colab_runner.ipynb`)
     * 环境检查和配置
     * 依赖安装
     * Google Drive挂载
     * 示例代码运行
   - 运行时优化
     * GPU加速支持
     * 并行计算
     * 会话管理
     * 进度保存

3. 配置调整
   - 修改缓存策略适配Colab环境
   - 优化内存使用
   - 添加检查点机制
   - 配置GPU支持

4. 注意事项
   - 需要Google Drive API凭证
   - 需要定期保存进度
   - 注意运行时限制
   - 管理内存使用

5. 后续计划
   - 添加更多运行示例
   - 优化GPU使用
   - 改进数据加载
   - 增强错误处理
   - 添加进度可视化

### 2024-04-19 更新（深夜）

#### 重要更新：完成CMap适配器开发

1. 核心功能实现
   - 实现了CMap API数据获取
   - 支持基因表达谱数据处理
   - 实现了表达模式分类
   - 添加了质量评分系统
   - 完成了数据标准化

2. 主要功能
   - 表达谱数据获取
     * 支持按基因列表查询
     * 支持按扰动物查询
     * 支持按细胞系查询
     * 支持最小zscore过滤
   - 表达模式分类
     * 上调模式识别
     * 下调模式识别
     * 混合模式识别
     * 未知模式处理
   - 质量控制
     * QC通过检查
     * 批次效应评估
     * 重复性评分
     * 综合质量评分

3. 技术细节
   - 数据结构优化
     * 使用DataFrame高效处理
     * 实现数据验证
     * 添加缓存机制
   - 评分系统
     * zscore阈值优化
     * 表达模式算法改进
     * 质量评分标准化

4. 单元测试
   - 完成全面测试用例
     * 初始化测试
     * 数据获取测试
     * 数据解析测试
     * 数据转换测试
     * 缓存机制测试
     * 错误处理测试
     * 表达模式分类测试
     * 质量评分计算测试

5. 遇到的问题
   - API响应格式复杂
   - 表达模式分类准确度
   - 质量评分标准确定
   
6. 解决方案
   - 实现统一的数据处理流程
   - 优化表达模式分类算法
   - 建立标准化的评分体系

7. 后续计划
   - 添加批量处理功能
   - 优化内存使用
   - 添加并行处理
   - 改进缓存策略
   - 增加数据可视化

## 2024-02-26

### 完成工作
1. 实现了数据适配器基类和以下适配器：
   - PDB适配器：用于获取蛋白质结构数据
   - PDBbind适配器：用于获取蛋白质-配体结合数据
   - BindingDB适配器：用于获取蛋白质-配体结合数据
   - UniProt适配器：用于获取蛋白质基本信息
   - AlphaFold适配器：用于获取预测的蛋白质结构
   - ChEMBL适配器：用于获取药物活性数据
   - DrugBank适配器：用于获取药物信息数据
   - DisGeNET适配器：用于获取疾病-基因关联数据
   - ZINC适配器：用于获取小分子化合物数据
   - OpenTargets适配器：用于获取靶点-疾病关联数据

2. 实现了UnifiedDataManager类，提供以下功能：
   - 统一的数据获取接口
   - 蛋白质数据整合
   - 蛋白质分类系统（四级分类）

3. 完成了单元测试：
   - 测试了UnifiedDataManager的初始化
   - 测试了数据获取功能
   - 测试了数据整合功能
   - 测试了蛋白质分类功能
   - 测试了错误处理机制
   - 所有测试用例均已通过

4. 新增ChEMBL适配器功能：
   - 实现了从ChEMBL API获取活性数据
   - 支持多种活性类型（IC50、Ki、Kd、EC50）
   - 实现了单位统一转换（转换为nM）
   - 添加了本地缓存机制
   - 完成了完整的单元测试
   - 修复了pandas SettingWithCopyWarning警告

5. 新增DrugBank适配器功能：
   - 实现了从DrugBank API获取药物数据
   - 支持获取已批准药物列表
   - 获取药物详细信息（包括物理化学性质、药代动力学等）
   - 获取药物靶点信息
   - 实现了本地缓存机制
   - 完成了完整的单元测试
   - 支持数据验证和错误处理

6. 新增DisGeNET适配器功能：
   - 实现了从DisGeNET API获取疾病-基因关联数据
   - 支持按疾病ID和基因ID查询
   - 提供关联强度评分和证据等级
   - 包含文献支持信息
   - 实现了本地缓存机制
   - 完成了完整的单元测试
   - 支持数据验证和错误处理

7. 新增ZINC适配器功能：
   - 实现了从ZINC API获取化合物数据
   - 支持多种化合物筛选条件
   - 提供化合物3D结构下载
   - 实现了药物相似性评分（基于Lipinski规则）
   - 添加了本地缓存机制
   - 完成了完整的单元测试
   - 支持数据验证和错误处理

8. 新增OpenTargets适配器功能：
   - 实现了从OpenTargets GraphQL API获取靶点-疾病关联数据
   - 支持按靶点ID和疾病ID查询
   - 提供关联强度评分和证据等级
   - 包含临床和遗传证据评估
   - 实现了本地缓存机制
   - 完成了完整的单元测试
   - 支持数据验证和错误处理

### 遇到的问题
1. 外部API访问问题：
   - UniProt API返回400错误
   - PDB API返回404错误
   - PDBbind数据需要手动下载
   
2. 解决方案：
   - 使用mock数据进行测试
   - 添加了本地缓存机制
   - 提供了详细的数据下载说明

3. ChEMBL适配器开发中的问题：
   - API响应数据结构不一致
   - 数据单位不统一
   - pandas警告问题
   
4. 解决方案：
   - 增加了数据验证和错误处理
   - 实现了单位统一转换函数
   - 使用DataFrame.copy()和loc避免警告

5. DrugBank适配器开发中的问题：
   - API需要认证
   - 数据结构复杂
   - 靶点信息需要额外处理
   
6. 解决方案：
   - 实现了API认证机制
   - 使用递归解析处理复杂数据
   - 添加了靶点数据的专门处理逻辑

7. DisGeNET适配器开发中的问题：
   - API响应格式多样
   - 证据评分标准不统一
   - 需要处理大量文献引用
   
8. 解决方案：
   - 实现了统一的数据处理流程
   - 建立了标准化的评分系统
   - 添加了证据等级计算逻辑

9. ZINC适配器开发中的问题：
   - API响应结构复杂
   - 3D结构下载失败
   - 药物相似性计算不准确
   
10. 解决方案：
    - 实现了统一的数据处理流程
    - 添加了结构下载重试机制
    - 优化了药物相似性计算逻辑

11. OpenTargets适配器开发中的问题：
    - GraphQL查询结构复杂
    - 证据类型多样
    - 评分标准不统一
    
12. 解决方案：
    - 实现了模块化的GraphQL查询
    - 建立了证据类型分类系统
    - 统一了评分和证据等级标准

### 下一步计划
1. 实现其他数据源适配器：
   - CMap适配器

2. 改进功能：
   - 添加数据验证机制
   - 优化数据缓存策略
   - 添加数据更新机制
   - 实现并行数据获取
   - 添加数据压缩功能

3. 测试计划：
   - 添加集成测试
   - 添加性能测试
   - 添加压力测试
   - 添加边界条件测试

[原有内容保持不变...] 